# Global Lock Hierarchy â€” Ascertescence Autonomic System
# Source: Adjudicator Bid CC35 (normalized)
# Rule: Always acquire locks in this order. Never acquire a lower-numbered lock while holding a higher-numbered one.
version: "1.0.0"

hierarchy:
  - order: 1
    name: LOCK_CANON_PROMOTION
    scope: "Canon promotion pipeline (protease_promote.py + Gate v2)"
    holders: [lattice_annealer, apoptosis_protocol, gate_v2]

  - order: 2
    name: LOCK_LATTICE_INDEX
    scope: "DYN-LATTICE_INDEX.json read/write"
    holders: [lattice_annealer, apoptosis_protocol]

  - order: 3
    name: LOCK_LATTICE_HEALTH
    scope: "DYN-LATTICE_HEALTH.json read/write"
    holders: [lattice_annealer, dag_tension_monitor]

  - order: 4
    name: LOCK_DAG_STATE
    scope: "DYN-DAG_STATE.json + DYN-DAG_SIGNAL.json"
    holders: [dag_tension_monitor]

  - order: 5
    name: LOCK_ANNEAL_LOG
    scope: "DYN-LATTICE_ANNEAL_LOG.jsonl append"
    holders: [lattice_annealer]

  - order: 6
    name: LOCK_APOPTOSIS_LEDGER
    scope: "DYN-APOPTOSIS_LEDGER.jsonl + DYN-APOPTOSIS_DEBT.json"
    holders: [apoptosis_protocol]

  - order: 7
    name: LOCK_RETIREMENT_REGISTRY
    scope: "ARCH-TOOL_NICHE_REGISTRY.yaml + DYN-RETIREMENT_LEDGER.jsonl"
    holders: [retirement_protocol]

  - order: 8
    name: LOCK_STRESS_PLAN
    scope: "DYN-STRESS_TEST_*.json"
    holders: [stress_test_sim]

  - order: 9
    name: LOCK_BANDWIDTH_LOG
    scope: "DYN-SOVEREIGN_BANDWIDTH_LOG.jsonl"
    holders: [stress_test_sim]

  - order: 10
    name: LOCK_INCIDENT_LOG
    scope: "DYN-ASCERTESCENCE_INCIDENTS.jsonl"
    holders: [incident_taxonomy]

implementation_notes:
  mechanism: "fcntl.flock() on .lock files in orchestration/00-ORCHESTRATION/state/locks/"
  timeout_ms: 5000
  stale_lock_detection: "Check PID in lock file; if PID dead, remove lock"
