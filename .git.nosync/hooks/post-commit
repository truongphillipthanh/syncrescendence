#!/bin/bash
# Constellation post-commit hook
# Updates state file with latest commit information
# Appends COMMIT event to Global Ledger

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null)"
FINGERPRINT=$(git rev-parse --short HEAD)
TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

cat > .constellation/state/current.yaml << EOF
fingerprint: $FINGERPRINT
timestamp: $TIMESTAMP
branch: $(git rev-parse --abbrev-ref HEAD)
message: $(git log -1 --pretty=%B | head -1)
EOF

# Append COMMIT event to Global Ledger
LEDGER_SCRIPT="$REPO_ROOT/orchestration/scripts/append_ledger.sh"
if [ -x "$LEDGER_SCRIPT" ]; then
    AUTHOR=$(git log -1 --pretty=%an 2>/dev/null | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
    MSG=$(git log -1 --pretty=%s 2>/dev/null | head -c 80)
    bash "$LEDGER_SCRIPT" COMMIT "$AUTHOR" "repo" "$MSG" 2>/dev/null || true
fi
